<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人口热力分布 - 河洛书苑生长笔记</title>
    <link rel="stylesheet" href="static/vendor/map/demo-center.css"/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body,
        #population-map {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
        }
        
        .input-card {
            position: fixed;
            top: 20px;
            right: 15px;
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 180px;
        }
        
        .input-item {
            margin-bottom: 8px;
        }

        .input-item:last-child {
            margin-bottom: 0;
        }

        /* 按钮组样式 */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn-group:last-child {
            margin-bottom: 0;
        }

        /* 分隔线 */
        .divider {
            height: 1px;
            background: #e8e8e8;
            margin: 8px 0;
        }
        
        .btn {
            width: 100%;
            height: 36px;
            background: #409EFF;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 0 12px;
            white-space: nowrap;
        }
        
        .btn:hover {
            background: #66b1ff;
            transform: translateY(-1px);
        }
        
        .btn.active {
            background: #FF4500;
        }

        /* 红色按钮样式 */
        .btn-danger {
            background: #FF4500;
        }

        .btn-danger:hover {
            background: #ff6433;
        }

        .amap-info-content {
            padding: 0 !important;
            max-width: 360px !important;
            background: rgba(255, 255, 255, 0.95) !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
            border: 1px solid rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            overflow: hidden !important;
        }
        
        .info-window {
            padding: 0;
            background: transparent;
        }

        .info-window-header {
            background: linear-gradient(135deg, #FF4500, #FF6B45) !important;
            color: white;
            padding: 16px 20px;
            font-size: 20px;
            font-weight: 600;
            border-radius: 12px 12px 0 0;
            position: relative;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .info-window-body {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }

        .info-item:last-child {
            margin-bottom: 0;
            padding-bottom: 12px;
            border-bottom: none;
        }

        .info-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 69, 0, 0.1);
            border-radius: 8px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(255, 69, 0, 0.1);
        }

        .info-icon svg {
            width: 20px;
            height: 20px;
            stroke: #FF4500;
        }

        .info-text {
            flex: 1;
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            font-weight: 500;
        }

        .info-text strong {
            color: #FF4500;
            font-weight: 700;
            text-shadow: 0 0 1px rgba(255, 69, 0, 0.1);
        }

        .info-priority {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, rgba(255, 69, 0, 0.1), rgba(255, 69, 0, 0.2));
            color: #FF4500;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(255, 69, 0, 0.1);
            border: 1px solid rgba(255, 69, 0, 0.2);
        }
        
        .amap-info-close {
            top: 16px !important;
            right: 16px !important;
            color: white !important;
            font-size: 20px !important;
            opacity: 0.8 !important;
            transition: opacity 0.3s !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
        }
        
        .amap-info-close:hover {
            opacity: 1 !important;
        }
        
        .amap-info-sharp {
            display: none !important;
        }
        
        .library-title {
            font-size: 24px !important;
            font-weight: 700 !important;
            color: #1a1a1a !important;
            margin-bottom: 16px !important;
            padding-bottom: 12px !important;
            border-bottom: 2px solid #f0f0f0 !important;
            border-radius: 2px !important;
            background: #ffffff !important;
        }
        
        .library-info {
            position: relative !important;
            font-size: 18px !important;
            line-height: 1.8 !important;
            color: #333333 !important;
            font-weight: 500 !important;
            background: #ffffff !important;
            z-index: 1 !important;
        }
        
        .library-info p {
            position: relative !important;
            margin: 12px 0 !important;
            padding: 6px 0 6px 28px !important;
            color: #333333 !important;
            line-height: 1.8 !important;
            font-weight: 500 !important;
            background: #ffffff !important;
            border-radius: 8px !important;
        }
        
        .library-info p::before {
            content: "" !important;
            position: absolute !important;
            left: 8px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            width: 8px !important;
            height: 8px !important;
            background: #409EFF !important;
            border-radius: 50% !important;
        }
        
        .legend {
            position: fixed;
            top: 270px;  /* 调整这个值以适应控件栏的高度 */
            right: 15px;
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 13px;
            width: 180px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        
        .legend-item:first-child {
            margin-top: 0;
        }
        
        .legend-item:last-child {
            margin-bottom: 0;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 4px;
        }
        
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 1000;
            display: none;
        }

        /* 返回按钮样式 */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: #fff;
            padding: 8px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
        }

        .back-button svg {
            width: 16px;
            height: 16px;
        }

        /* 地图说明样式 */
        .map-info {
            position: fixed;
            bottom: 20px;
            right: 15px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1000;
            width: 180px;
            font-size: 13px;
        }

        .map-info-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }

        .map-legend-group {
            margin-bottom: 16px;
        }

        .map-legend-group:last-child {
            margin-bottom: 0;
        }

        .map-legend-subtitle {
            font-size: 13px;
            font-weight: 500;
            color: #666;
            margin-bottom: 6px;
        }

        .map-legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
            font-size: 12px;
            color: #666;
        }

        .map-legend-color {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        /* 初始提示框样式 */
        .initial-tip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 320px;
            text-align: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease-out;
        }

        .initial-tip-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .initial-tip-content {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .initial-tip-btn {
            background: #409EFF;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .initial-tip-btn:hover {
            background: #66b1ff;
            transform: translateY(-1px);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -40%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
    </style>
</head>
<body>
    <a href="index.html#populationMapPreview" class="back-button" title="返回主页">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span>返回主页</span>
    </a>
    <div id="population-map"></div>
    <div class="initial-tip" id="initialTip">
        <div class="initial-tip-title">使用说明</div>
        <div class="initial-tip-content">
            • 点击右上角全屏按钮获得最佳体验<br>
            • 点击左上角可返回主页<br>
            • 右上角按钮可切换显示热力图和服务范围<br>
            • 点击城市书房服务范围可查看详细信息<br>
            • 红色区域表示服务盲区，点击可查看建议<br>
            • 图例说明位于右下角
        </div>
        <button class="initial-tip-btn" onclick="closeInitialTip()">我知道了</button>
    </div>
    <div class="input-card">
        <div class="btn-group">
            <button class="btn" onclick="toggleHeatmap()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 3v18M3 12h18"/>
                </svg>
                显示/隐藏热力图
            </button>
            <button class="btn" onclick="toggleLibraries()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                </svg>
                显示/隐藏服务范围
            </button>
            <button class="btn" onclick="toggleOverlapStyle()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 14h16M4 9h16M4 19h16"/>
                </svg>
                切换覆盖样式
            </button>
        </div>
        <div class="divider"></div>
        <div class="btn-group">
            <button class="btn btn-danger" onclick="toggleBlindArea()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                显示/隐藏盲点
            </button>
            <button class="btn btn-danger" onclick="toggleBlindAreaPolygon()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M3 12h18M3 18h18"/>
                </svg>
                显示/隐藏盲区
            </button>
        </div>
    </div>
    <div class="legend" id="legend" style="display: none;">
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(0, 139, 139, 0.25)"></div>
            <span>单一覆盖区域</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(0, 139, 139, 0.4)"></div>
            <span>2-3个重叠区域</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(0, 139, 139, 0.6)"></div>
            <span>多个重叠区域</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(255, 69, 0, 0.6)"></div>
            <span>服务盲点</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(255, 0, 0, 0.4)"></div>
            <span>服务盲区</span>
        </div>
    </div>
    <div class="map-info">
        <div class="map-info-title">地图图例说明</div>
        
        <div class="map-legend-group">
            <div class="map-legend-subtitle">人口热力分布</div>
            <div class="map-legend-item">
                <div class="map-legend-color" style="background: rgb(0,0,255)"></div>
                <span>人口密度较低</span>
            </div>
            <div class="map-legend-item">
                <div class="map-legend-color" style="background: rgb(117,211,248)"></div>
                <span>人口密度中等</span>
            </div>
            <div class="map-legend-item">
                <div class="map-legend-color" style="background: rgb(0,255,0)"></div>
                <span>人口密度较高</span>
            </div>
            <div class="map-legend-item">
                <div class="map-legend-color" style="background: rgb(255,240,0)"></div>
                <span>人口密度高</span>
            </div>
            <div class="map-legend-item">
                <div class="map-legend-color" style="background: rgb(255,0,0)"></div>
                <span>人口密度极高</span>
            </div>
        </div>

        <div class="map-legend-group">
            <div class="map-legend-subtitle">服务覆盖范围</div>
            <div class="map-legend-item">
                <div class="map-legend-color" style="background: rgba(0, 139, 139, 0.25)"></div>
                <span>单一覆盖区域</span>
            </div>
            <div class="map-legend-item">
                <div class="map-legend-color" style="background: rgba(0, 139, 139, 0.4)"></div>
                <span>2-3个重叠区域</span>
            </div>
            <div class="map-legend-item">
                <div class="map-legend-color" style="background: rgba(0, 139, 139, 0.6)"></div>
                <span>多个重叠区域</span>
            </div>
        </div>

        <div class="map-legend-group">
            <div class="map-legend-subtitle">服务盲区</div>
            <div class="map-legend-item">
                <div class="map-legend-color" style="background: rgba(255, 69, 0, 0.6)"></div>
                <span>人口密集盲点</span>
            </div>
            <div class="map-legend-item">
                <div class="map-legend-color" style="background: rgba(255, 0, 0, 0.4)"></div>
                <span>服务盲区</span>
            </div>
        </div>
    </div>


<script type="text/javascript" src="static/js/heatmapData.js"></script>
<script type="text/javascript" src="static/js/libraryData.js"></script>
<script src="https://webapi.amap.com/maps?v=1.4.15&key=8c0f2606de763666d42b04bb5ec5b0e3&plugin=AMap.MarkerClusterer"></script>
<script type="text/javascript">
    var map, heatmap, libraryLayer;
    var isHeatmapVisible = true;
    var isLibraryVisible = false;
    var isBlindAreaVisible = false;
    var isBlindAreaPolygonVisible = false;
    var circles = [];
    var blindAreaPolygons = [];
    var blindAreaMergedPolygons = [];
    var isOverlapStyle = false;
    var currentInfoWindow = null;

    // 初始化地图
    function initMap() {
        map = new AMap.Map("population-map", {
            resizeEnable: true,
            center: [112.434468, 34.663041],  // 洛阳市中心坐标
            zoom: 11
        });

        if (!isSupportCanvas()) {
            alert('热力图仅对支持canvas的浏览器适用,您所使用的浏览器不能使用热力图功能,请换个浏览器试试~')
            return;
        }

        // 初始化热力图
        map.plugin(["AMap.Heatmap"], function () {
            const canvas = document.createElement('canvas');
            canvas.setAttribute('willReadFrequently', true);
            
            heatmap = new AMap.Heatmap(map, {
                radius: 25,
                opacity: [0.1, 0.8],
                gradient: {
                    0.2: 'rgb(0,0,255)',
                    0.4: 'rgb(117,211,248)',
                    0.6: 'rgb(0,255,0)',
                    0.8: 'rgb(255,240,0)',
                    1.0: 'rgb(255,0,0)'
                },
                canvas: canvas
            });

            heatmap.setDataSet({
                data: heatmapData,
                max: 100
            });
        });

        // 加载城市书房数据
        loadLibraryData().then(() => {
            createLibraryCircles();
            // 在服务范围创建完成后初始化盲区
            initBlindAreas();
            
            // 默认显示服务范围
            map.add(libraryLayer);
            isLibraryVisible = true;
        });
    }

    // 判断浏览器是否支持canvas
    function isSupportCanvas() {
        var elem = document.createElement('canvas');
        elem.setAttribute('willReadFrequently', true);  // 添加willReadFrequently属性
        return !!(elem.getContext && elem.getContext('2d'));
    }

    // 创建城市书房服务范围圆形
    function createLibraryCircles() {
        libraryData.forEach(function(library) {
            var circle = new AMap.Circle({
                center: library.position,
                radius: 1500,  // 1.5千米半径
                strokeColor: "#008B8B",  // 深青色边框
                strokeOpacity: 0.6,
                strokeWeight: 1.5,
                fillColor: "#008B8B",    // 深青色填充
                fillOpacity: 0.25,
                cursor: 'pointer',
                strokeStyle: 'dashed'    // 虚线边框
            });

            // 添加点击事件
            circle.on('click', function(e) {
                if (currentInfoWindow) {
                    currentInfoWindow.close();
                }
                
                var info = new AMap.InfoWindow({
                    isCustom: true,
                    autoMove: true,
                    closeWhenClickMap: true,
                    content: `
                        <div class="info-window">
                            <div class="info-window-header" style="background: linear-gradient(135deg, #2ecc71, #27ae60) !important;">
                                ${library.name}
                            </div>
                            <div class="info-window-body">
                                <div class="info-item">
                                    <div class="info-icon" style="background: rgba(46, 204, 113, 0.1);">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                    </div>
                                    <div class="info-text">
                                        <strong style="color: #2ecc71;">地址：</strong>${library.address}
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-icon" style="background: rgba(46, 204, 113, 0.1);">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2">
                                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="info-text">
                                        <strong style="color: #2ecc71;">藏书：</strong>${library.books}册
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-icon" style="background: rgba(46, 204, 113, 0.1);">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2">
                                            <path d="M20 7h-9"></path>
                                            <path d="M14 17H5"></path>
                                            <circle cx="17" cy="17" r="3"></circle>
                                            <circle cx="7" cy="7" r="3"></circle>
                                        </svg>
                                    </div>
                                    <div class="info-text">
                                        <strong style="color: #2ecc71;">座位：</strong>${library.seats}个
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-icon" style="background: rgba(46, 204, 113, 0.1);">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M12 6 12 12 16 14"></path>
                                        </svg>
                                    </div>
                                    <div class="info-text">
                                        <strong style="color: #2ecc71;">开放时间：</strong>${library.opening_hours || '8:30-20:30'}
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-icon" style="background: rgba(46, 204, 113, 0.1);">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                            <path d="M2 12h20"></path>
                                        </svg>
                                    </div>
                                    <div class="info-text">
                                        <strong style="color: #2ecc71;">服务半径：</strong>1.5千米
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                    offset: new AMap.Pixel(0, -20)
                });

                info.open(map, library.position);
                currentInfoWindow = info;
                
                e.stopPropagation();
            });

            circles.push(circle);
        });

        libraryLayer = new AMap.OverlayGroup(circles);
        
        // 添加地图点击事件，关闭信息窗口
        map.on('click', function() {
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
        });
    }

    // 切换热力图显示/隐藏
    function toggleHeatmap() {
        if (isHeatmapVisible) {
            heatmap.hide();
        } else {
            heatmap.show();
        }
        isHeatmapVisible = !isHeatmapVisible;
    }

    // 切换覆盖样式
    function toggleOverlapStyle() {
        isOverlapStyle = !isOverlapStyle;
        document.getElementById('legend').style.display = isOverlapStyle ? 'block' : 'none';
        
        if (isOverlapStyle) {
            circles.forEach(circle => {
                circle.setOptions({
                    strokeColor: "#008B8B",
                    strokeOpacity: 0.4,
                    strokeWeight: 1.5,
                    fillColor: "#008B8B",
                    fillOpacity: 0.25,
                    strokeStyle: 'solid'
                });
            });
        } else {
            circles.forEach(circle => {
                circle.setOptions({
                    strokeColor: "#008B8B",
                    strokeOpacity: 0.6,
                    strokeWeight: 1.5,
                    fillColor: "#008B8B",
                    fillOpacity: 0.25,
                    strokeStyle: 'dashed'
                });
            });
        }
    }

    // 切换城市书房服务范围显示/隐藏
    function toggleLibraries() {
        if (!libraryLayer) {
            createLibraryCircles();
        }
        
        if (isLibraryVisible) {
            map.remove(libraryLayer);
            document.getElementById('legend').style.display = 'none';
        } else {
            map.add(libraryLayer);
            if (isOverlapStyle) {
                document.getElementById('legend').style.display = 'block';
            }
        }
        isLibraryVisible = !isLibraryVisible;
    }

    // 计算和创建服务盲区
    function initBlindAreas() {
        // 清空现有盲区
        blindAreaPolygons.forEach(polygon => {
            map.remove(polygon);
        });
        blindAreaPolygons = [];
        
        blindAreaMergedPolygons.forEach(polygon => {
            map.remove(polygon);
        });
        blindAreaMergedPolygons = [];
        
        // 筛选出高密度点（热力值大于80的点）
        const highDensityPoints = heatmapData.filter(point => point.count > 80);
        const blindPoints = [];
        
        highDensityPoints.forEach(point => {
            let isInServiceArea = false;
            const pointLngLat = new AMap.LngLat(point.lng, point.lat);
            
            // 检查该点是否在任何服务范围内
            for (let circle of circles) {
                const center = circle.getCenter();
                const distance = pointLngLat.distance(center);
                if (distance <= 1500) {  // 1.5km服务半径
                    isInServiceArea = true;
                    break;
                }
            }
            
            // 如果不在服务范围内，创建盲区标记
            if (!isInServiceArea) {
                blindPoints.push(point);
                const blindArea = createBlindAreaMarker(point, pointLngLat);
                blindAreaPolygons.push(blindArea);
            }
        });

        // 创建盲区多边形
        createBlindAreaPolygons(blindPoints);
    }

    // Graham扫描法计算凸包
    function convexHull(points) {
        if (points.length < 3) {
            // 如果点数小于3，直接返回这些点围成的多边形
            return points;
        }

        // 找到最左下方的点作为起始点
        let start = points[0];
        for (let i = 1; i < points.length; i++) {
            if (points[i][1] < start[1] || (points[i][1] === start[1] && points[i][0] < start[0])) {
                start = points[i];
            }
        }

        // 计算其他点相对于起始点的极角
        const sortedPoints = points.filter(p => p !== start).sort((a, b) => {
            const angleA = Math.atan2(a[1] - start[1], a[0] - start[0]);
            const angleB = Math.atan2(b[1] - start[1], b[0] - start[0]);
            if (angleA === angleB) {
                // 如果极角相同，选择距离起始点更远的点
                const distA = (a[0] - start[0]) * (a[0] - start[0]) + (a[1] - start[1]) * (a[1] - start[1]);
                const distB = (b[0] - start[0]) * (b[0] - start[0]) + (b[1] - start[1]) * (b[1] - start[1]);
                return distB - distA;
            }
            return angleA - angleB;
        });

        // 构建凸包
        const hull = [start];
        for (const point of sortedPoints) {
            while (hull.length >= 2 && !isLeftTurn(hull[hull.length - 2], hull[hull.length - 1], point)) {
                hull.pop();
            }
            hull.push(point);
        }

        // 确保首尾相连
        if (hull.length >= 3) {
            hull.push(hull[0]);
        }

        return hull;
    }

    // 判断是否左转
    function isLeftTurn(p1, p2, p3) {
        return (p2[0] - p1[0]) * (p3[1] - p1[1]) -
               (p2[1] - p1[1]) * (p3[0] - p1[0]) > 0;
    }

    // 创建盲区多边形
    function createBlindAreaPolygons(blindPoints) {
        if (blindPoints.length === 0) return;

        // 使用DBSCAN算法对盲点进行聚类
        const clusters = dbscan(blindPoints, 2000, 2);

        clusters.forEach(cluster => {
            if (cluster.length < 2) return;

            // 创建凸包
            const points = cluster.map(point => [point.lng, point.lat]);
            
            // 判断是否为线性分布
            const isLinear = isLinearDistribution(points);
            
            if (isLinear) {
                // 为线性分布创建缓冲区
                const bufferedPoints = createBufferZone(points);
                // 创建多边形
                const polygon = new AMap.Polygon({
                    path: bufferedPoints,
                    strokeColor: "#FF0000",
                    strokeWeight: 2,
                    strokeOpacity: 0.8,
                    fillColor: '#FF0000',
                    fillOpacity: 0.4,
                    cursor: 'pointer'
                });
                
                // 添加点击事件
                addPolygonClickEvent(polygon, cluster);
                blindAreaMergedPolygons.push(polygon);
            } else {
                // 非线性分布使用原有的凸包算法
                const hull = convexHull(points);
                if (hull.length < 3) return;
                
                const polygon = new AMap.Polygon({
                    path: hull,
                    strokeColor: "#FF0000",
                    strokeWeight: 2,
                    strokeOpacity: 0.8,
                    fillColor: '#FF0000',
                    fillOpacity: 0.4,
                    cursor: 'pointer'
                });
                
                addPolygonClickEvent(polygon, cluster);
                blindAreaMergedPolygons.push(polygon);
            }
        });
    }

    // 判断是否为线性分布
    function isLinearDistribution(points) {
        if (points.length < 3) return true;
        
        // 计算点到直线的最大距离
        const start = points[0];
        const end = points[points.length - 1];
        
        let maxDistance = 0;
        for (let i = 1; i < points.length - 1; i++) {
            const distance = pointToLineDistance(points[i], start, end);
            maxDistance = Math.max(maxDistance, distance);
        }
        
        // 如果最大距离小于线段长度的10%，认为是线性分布
        const lineLength = Math.sqrt(
            Math.pow(end[0] - start[0], 2) + 
            Math.pow(end[1] - start[1], 2)
        );
        
        return maxDistance < lineLength * 0.1;
    }

    // 计算点到直线的距离
    function pointToLineDistance(point, lineStart, lineEnd) {
        const numerator = Math.abs(
            (lineEnd[1] - lineStart[1]) * point[0] -
            (lineEnd[0] - lineStart[0]) * point[1] +
            lineEnd[0] * lineStart[1] -
            lineEnd[1] * lineStart[0]
        );
        
        const denominator = Math.sqrt(
            Math.pow(lineEnd[1] - lineStart[1], 2) +
            Math.pow(lineEnd[0] - lineStart[0], 2)
        );
        
        return numerator / denominator;
    }

    // 创建缓冲区
    function createBufferZone(points) {
        if (points.length < 2) return points;
        
        const bufferDistance = 0.005; // 约500米的经纬度距离
        const bufferedPoints = [];
        
        // 添加起点的缓冲区圆弧点
        const startPoint = points[0];
        for (let i = 0; i <= 10; i++) {
            const angle = Math.PI * i / 10;
            const x = startPoint[0] + bufferDistance * Math.cos(angle);
            const y = startPoint[1] + bufferDistance * Math.sin(angle);
            bufferedPoints.push([x, y]);
        }
        
        // 创建平行线上的点
        for (let i = 0; i < points.length - 1; i++) {
            const p1 = points[i];
            const p2 = points[i + 1];
            
            // 计算垂直向量
            const dx = p2[0] - p1[0];
            const dy = p2[1] - p1[1];
            const length = Math.sqrt(dx * dx + dy * dy);
            const normalX = -dy / length * bufferDistance;
            const normalY = dx / length * bufferDistance;
            
            bufferedPoints.push([p2[0] + normalX, p2[1] + normalY]);
        }
        
        // 添加终点的缓冲区圆弧点
        const endPoint = points[points.length - 1];
        for (let i = 0; i <= 10; i++) {
            const angle = Math.PI + Math.PI * i / 10;
            const x = endPoint[0] + bufferDistance * Math.cos(angle);
            const y = endPoint[1] + bufferDistance * Math.sin(angle);
            bufferedPoints.push([x, y]);
        }
        
        // 添加下方的点（反向）
        for (let i = points.length - 1; i > 0; i--) {
            const p1 = points[i];
            const p2 = points[i - 1];
            
            const dx = p2[0] - p1[0];
            const dy = p2[1] - p1[1];
            const length = Math.sqrt(dx * dx + dy * dy);
            const normalX = dy / length * bufferDistance;
            const normalY = -dx / length * bufferDistance;
            
            bufferedPoints.push([p1[0] + normalX, p1[1] + normalY]);
        }
        
        // 闭合多边形
        bufferedPoints.push(bufferedPoints[0]);
        
        return bufferedPoints;
    }

    // 添加多边形点击事件
    function addPolygonClickEvent(polygon, cluster) {
        polygon.on('click', function(e) {
            if (currentInfoWindow) {
                currentInfoWindow.close();
            }
            
            var info = new AMap.InfoWindow({
                isCustom: true,
                autoMove: true,
                closeWhenClickMap: true,
                content: `
                    <div class="info-window">
                        <div class="info-window-header">
                            服务盲区群
                        </div>
                        <div class="info-window-body">
                            <div class="info-item">
                                <div class="info-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                </div>
                                <div class="info-text">
                                    包含<strong>${cluster.length}个</strong>人口密集盲点
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                    </svg>
                                </div>
                                <div class="info-text">
                                    建议在此区域规划新的城市书房
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                                    </svg>
                                </div>
                                <div class="info-text">
                                    优先级：<span class="info-priority">高</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                offset: new AMap.Pixel(0, -20)
            });
            
            info.open(map, polygon.getBounds().getCenter());
            currentInfoWindow = info;
            
            e.stopPropagation();
        });
    }

    // DBSCAN聚类算法
    function dbscan(points, eps, minPts) {
        const clusters = [];
        const visited = new Set();
        
        points.forEach(point => {
            if (visited.has(point)) return;
            visited.add(point);
            
            const neighbors = getNeighbors(point, points, eps);
            if (neighbors.length < minPts) return;
            
            const cluster = [point];
            expandCluster(points, neighbors, cluster, eps, minPts, visited);
            clusters.push(cluster);
        });
        
        return clusters;
    }

    // 获取邻近点
    function getNeighbors(point, points, eps) {
        return points.filter(p => {
            if (p === point) return false;
            const distance = new AMap.LngLat(point.lng, point.lat)
                .distance([p.lng, p.lat]);
            return distance <= eps;
        });
    }

    // 扩展聚类
    function expandCluster(points, neighbors, cluster, eps, minPts, visited) {
        neighbors.forEach(neighbor => {
            if (!visited.has(neighbor)) {
                visited.add(neighbor);
                const newNeighbors = getNeighbors(neighbor, points, eps);
                if (newNeighbors.length >= minPts) {
                    neighbors.push(...newNeighbors.filter(n => !neighbors.includes(n)));
                }
            }
            if (!cluster.includes(neighbor)) {
                cluster.push(neighbor);
            }
        });
    }

    // 切换盲点显示/隐藏
    function toggleBlindArea() {
        if (isBlindAreaVisible) {
            blindAreaPolygons.forEach(polygon => {
                map.remove(polygon);
            });
        } else {
            blindAreaPolygons.forEach(polygon => {
                map.add(polygon);
            });
        }
        isBlindAreaVisible = !isBlindAreaVisible;
    }

    // 切换盲区多边形显示/隐藏
    function toggleBlindAreaPolygon() {
        if (isBlindAreaPolygonVisible) {
            blindAreaMergedPolygons.forEach(polygon => {
                map.remove(polygon);
            });
        } else {
            blindAreaMergedPolygons.forEach(polygon => {
                map.add(polygon);
            });
        }
        isBlindAreaPolygonVisible = !isBlindAreaPolygonVisible;
    }

    // 修改盲区标记的点击事件
    function createBlindAreaMarker(point, pointLngLat) {
        const blindArea = new AMap.Circle({
            center: [point.lng, point.lat],
            radius: 200,
            strokeColor: "#FF4500",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF4500",
            fillOpacity: 0.6,
            strokeStyle: 'solid'
        });
        
        blindArea.on('click', function(e) {
            if (currentInfoWindow) {
                currentInfoWindow.close();
            }
            
            var info = new AMap.InfoWindow({
                isCustom: true,
                autoMove: true,
                closeWhenClickMap: true,
                content: `
                    <div class="info-window">
                        <div class="info-window-header">
                            服务盲区
                        </div>
                        <div class="info-window-body">
                            <div class="info-item">
                                <div class="info-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                </div>
                                <div class="info-text">
                                    该区域人口密度<strong>较高</strong>，但目前未被任何城市书房覆盖
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                                    </svg>
                                </div>
                                <div class="info-text">
                                    建议在此区域规划新的城市书房以提升服务覆盖率
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                                    </svg>
                                </div>
                                <div class="info-text">
                                    优先级：<span class="info-priority">高</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                offset: new AMap.Pixel(0, -20)
            });
            
            info.open(map, pointLngLat);
            currentInfoWindow = info;
            
            e.stopPropagation();
        });
        
        return blindArea;
    }

    // 在现有的 JavaScript 代码开头添加关闭提示框的函数
    function closeInitialTip() {
        const tip = document.getElementById('initialTip');
        tip.style.opacity = '0';
        setTimeout(() => {
            tip.style.display = 'none';
        }, 500);
    }

    // 初始化地图
    initMap();
</script>
</body>
</html>
