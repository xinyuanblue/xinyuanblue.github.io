function initializeLanguageSwitch(){const e=localStorage.getItem("selectedLanguage")||"zh";document.documentElement.lang=e;const t=document.querySelectorAll(".language-switch button");function a(e){t.forEach((t=>{t.dataset.lang===e?(t.classList.add("active"),t.setAttribute("aria-pressed","true")):(t.classList.remove("active"),t.setAttribute("aria-pressed","false"))}))}t.forEach((e=>{e.addEventListener("click",(function(){const e=this.dataset.lang;if(document.documentElement.lang!==e){document.documentElement.lang=e;try{localStorage.setItem("selectedLanguage",e)}catch(e){console.error("无法保存语言设置到LocalStorage:",e)}a(e),"function"==typeof translatePage?setTimeout((()=>translatePage(e)),50):console.error("translatePage function not found. Make sure translations.js is loaded correctly."),document.dispatchEvent(new CustomEvent("languageChange",{detail:{lang:e}}))}}))})),a(e),"function"==typeof translatePage?translatePage(e):console.error("translatePage function not found for initial load.")}function initializeMapFullscreenLogic(){function e(){const e=document.querySelector(".fullscreen-button i");e&&(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement?e.className="fas fa-compress":e.className="fas fa-expand")}window.toggleFullScreen=function(e){const t=document.getElementById(e);t?document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():t.requestFullscreen?t.requestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):console.error("Element with ID '"+e+"' not found for fullscreen.")},document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e),document.addEventListener("mozfullscreenchange",e),document.addEventListener("MSFullscreenChange",e)}function initializeBookstoreTreemap(){const e=document.getElementById("bookstoreTreemap");if(!e||"undefined"==typeof echarts)return;const t=echarts.init(e,null,{renderer:"canvas"});let a=null,n=null;function o(r=!1){fetch("static/js/面积.json").then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).then((e=>{const i={"小型书房":[],"中型书房":[],"大型书房":[],"特大型书房":[]},l={};e.forEach((e=>{const t=e.书房类型;i.hasOwnProperty(t)?i[t].push(e):console.warn("Unknown bookstore type:",t)})),Object.keys(i).forEach((e=>{l[e]=i[e].reduce(((e,t)=>e+(t.面积||0)),0)}));const s=[{name:`小型书房 (${i["小型书房"].length}座)`,value:l["小型书房"],itemStyle:{color:"#FF9F40"},id:"小型书房"},{name:`中型书房 (${i["中型书房"].length}座)`,value:l["中型书房"],itemStyle:{color:"#36A2EB"},id:"中型书房"},{name:`大型书房 (${i["大型书房"].length}座)`,value:l["大型书房"],itemStyle:{color:"#4BC0C0"},id:"大型书房"},{name:`特大型书房 (${i["特大型书房"].length}座)`,value:l["特大型书房"],itemStyle:{color:"#9966FF"},id:"特大型书房"}],c={};Object.keys(i).forEach((e=>{c[e]={name:s.find((t=>t.id===e))?.name||e,value:l[e],itemStyle:s.find((t=>t.id===e))?.itemStyle||{},children:i[e].map((t=>({name:t.名称,value:t.面积||0,district:t.辖区||"N/A",itemStyle:{color:s.find((t=>t.id===e))?.itemStyle?.color||"#ccc"}})))}}));const d=r||null===a?s:c[a]?[c[a]]:s,u={tooltip:{formatter:function(e){const t=e.data;return t?t.name.includes("座")?`${t.name}<br/>总面积: ${t.value?.toFixed(1)??"N/A"}㎡`:`${t.name||"未知书房"}<br/>面积: ${t.value?.toFixed(1)??"N/A"}㎡<br/>辖区: ${t.district||"未知"}`:""}},series:[{type:"treemap",data:d,roam:!1,width:"100%",height:"100%",left:0,top:0,right:0,bottom:0,itemStyle:{borderWidth:1,gapWidth:1,borderColor:"#fff"},label:{show:!0,formatter:function(e){return e.data.name.includes("座")||null!==a&&e.data.value>0?e.data.name:""},fontSize:14,overflow:"break",color:"#fff",textShadowBlur:2,textShadowColor:"rgba(0, 0, 0, 0.5)"},upperLabel:{show:null===a,height:30,formatter:"{b}",color:"#fff",fontSize:16,textShadowBlur:3,textShadowColor:"rgba(0, 0, 0, 0.7)"},breadcrumb:{show:!1},nodeClick:null===a&&"link",emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowOffsetY:0,shadowColor:"rgba(0,0,0,0.3)"}},layoutAnimation:!0,animationDurationUpdate:500}]};t.setOption(u,!0),t._handlers&&t._handlers.click||t.on("click",(function(e){null===a&&e.data.id&&c[e.data.id]&&(a=e.data.id,o(!1),n&&(n.style.display="block"))}))})).catch((t=>{console.error("加载面积数据失败:",t),e.innerHTML='<div style="text-align:center;color:red;padding:20px;">加载数据失败，请刷新重试</div>'}))}n||(n=document.createElement("button"),n.textContent="返回书房类型总览",n.style.cssText="position: absolute; top: 100px; right: 0; z-index: 1000; padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px 0 0 0; cursor: pointer; display: none;",e.parentNode.appendChild(n),n.addEventListener("click",(function(){null!==a&&(o(!0),this.style.display="none",a=null)}))),o(!0),window.addEventListener("resize",(function(){t.resize()}))}function initializeDistrictDistributionChart(){document.getElementById("districtChart")}function initializePopulationCharts(){document.getElementById("populationChart"),document.getElementById("perCapitaChart")}function initializeVisitorBorrowingCharts(){const e=document.getElementById("hourlyChart"),t=document.getElementById("dailyChart"),a=document.getElementById("subjectChart");if(!e||!t||!a||"undefined"==typeof echarts)return;const n=echarts.init(e),o=echarts.init(t),r=echarts.init(a),i=[{hour:0,average_visitors:38},{hour:1,average_visitors:0},{hour:2,average_visitors:0},{hour:3,average_visitors:0},{hour:4,average_visitors:6},{hour:5,average_visitors:3},{hour:6,average_visitors:17},{hour:7,average_visitors:65},{hour:8,average_visitors:1409},{hour:9,average_visitors:1764},{hour:10,average_visitors:1662},{hour:11,average_visitors:1723},{hour:12,average_visitors:1478},{hour:13,average_visitors:1574},{hour:14,average_visitors:2083},{hour:15,average_visitors:1994},{hour:16,average_visitors:1946},{hour:17,average_visitors:1984},{hour:18,average_visitors:1787},{hour:19,average_visitors:1238},{hour:20,average_visitors:670},{hour:21,average_visitors:77},{hour:22,average_visitors:18},{hour:23,average_visitors:30}],l=[{date:"2025-03-13",visitors:20989,dateType:"workday"},{date:"2025-03-14",visitors:21235,dateType:"workday"},{date:"2025-03-15",visitors:37727,dateType:"weekend"},{date:"2025-03-16",visitors:24645,dateType:"weekend"},{date:"2025-03-17",visitors:17373,dateType:"workday"},{date:"2025-03-18",visitors:16698,dateType:"workday"},{date:"2025-03-19",visitors:17561,dateType:"workday"},{date:"2025-03-20",visitors:17336,dateType:"workday"},{date:"2025-03-21",visitors:19477,dateType:"workday"},{date:"2025-03-22",visitors:38476,dateType:"weekend"},{date:"2025-03-23",visitors:24073,dateType:"weekend"},{date:"2025-03-24",visitors:16677,dateType:"workday"},{date:"2025-03-25",visitors:17549,dateType:"workday"},{date:"2025-03-26",visitors:16878,dateType:"workday"},{date:"2025-03-27",visitors:15368,dateType:"workday"},{date:"2025-03-28",visitors:17994,dateType:"workday"},{date:"2025-03-29",visitors:35560,dateType:"weekend"},{date:"2025-03-30",visitors:22333,dateType:"weekend"},{date:"2025-03-31",visitors:15628,dateType:"workday"},{date:"2025-04-01",visitors:16180,dateType:"workday"},{date:"2025-04-02",visitors:15581,dateType:"workday"},{date:"2025-04-03",visitors:16356,dateType:"workday"},{date:"2025-04-04",visitors:30890,dateType:"holiday"}],s=[{name:"文学",borrowing_count:10442367,percentage:61.13},{name:"艺术",borrowing_count:1234651,percentage:7.23},{name:"历史、地理",borrowing_count:996970,percentage:5.84},{name:"文化、科学、教育、体育",borrowing_count:949105,percentage:5.56},{name:"政治、法律",borrowing_count:876543,percentage:5.13},{name:"经济",borrowing_count:745678,percentage:4.36},{name:"语言、文字",borrowing_count:681075,percentage:3.99},{name:"哲学、宗教",borrowing_count:615892,percentage:3.61},{name:"医药、卫生",borrowing_count:543210,percentage:3.18},{name:"农业科学",borrowing_count:432109,percentage:2.53},{name:"工业技术",borrowing_count:321098,percentage:1.88},{name:"数理科学和化学",borrowing_count:210987,percentage:1.24},{name:"自然科学总论",borrowing_count:176543,percentage:1.03},{name:"天文学、地球科学",borrowing_count:154321,percentage:.9},{name:"生物科学",borrowing_count:132109,percentage:.77},{name:"马克思主义、列宁主义、毛泽东思想",borrowing_count:98765,percentage:.58},{name:"综合性图书",borrowing_count:76543,percentage:.45},{name:"交通运输",borrowing_count:65432,percentage:.38},{name:"航空、航天",borrowing_count:54321,percentage:.32},{name:"环境科学、安全科学",borrowing_count:43210,percentage:.25},{name:"军事",borrowing_count:32109,percentage:.19}],c={tooltip:{trigger:"axis",formatter:e=>`${e[0].axisValue}:00 - ${e[0].axisValue}:59<br/>平均客流量: ${e[0].value?.toLocaleString()??0} 人次`},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:i.map((e=>e.hour)),name:"小时",axisLabel:{formatter:"{value}:00"}},yAxis:{type:"value",name:"平均客流量（人次）"},series:[{name:"平均客流量",type:"line",smooth:!0,data:i.map((e=>e.average_visitors)),itemStyle:{color:"#4CAF50"},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(76, 175, 80, 0.6)"},{offset:1,color:"rgba(76, 175, 80, 0.1)"}]}}}]};n.setOption(c);const d={workday:"#2196F3",weekend:"#FF9800",holiday:"#E91E63"},u={tooltip:{trigger:"axis",formatter:e=>{const t=l.find((t=>t.date===e[0].name));let a="";return t&&("weekend"===t.dateType?a='<br/><span style="color:#FF9800">周末</span>':"holiday"===t.dateType&&(a='<br/><span style="color:#E91E63">节假日</span>')),`日期: ${e[0].name}<br/>客流量: ${e[0].value?.toLocaleString()??0} 人次${a}`}},grid:{left:"3%",right:"4%",bottom:"10%",containLabel:!0},xAxis:{type:"category",data:l.map((e=>e.date)),name:"日期",axisLabel:{rotate:45,interval:"auto"}},yAxis:{type:"value",name:"客流量（人次）"},series:[{name:"客流量",type:"bar",data:l.map((e=>({value:e.visitors,itemStyle:{color:d[e.dateType]||"#cccccc"}}))),emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}],legend:{data:[{name:"工作日",itemStyle:{color:d.workday}},{name:"周末",itemStyle:{color:d.weekend}},{name:"节假日",itemStyle:{color:d.holiday}}],bottom:0,itemWidth:15,itemHeight:10,textStyle:{fontSize:12}}};o.setOption(u);const m=s.slice(0,10),p=s.slice(10);let g=p.reduce(((e,t)=>e+(t.percentage||0)),0),f=p.reduce(((e,t)=>e+(t.borrowing_count||0)),0);const v=m.map((e=>({name:e.name,value:e.percentage||0,borrowing_count:e.borrowing_count||0})));g>0&&v.push({name:"其他",value:Number(g.toFixed(2)),borrowing_count:f});const y={tooltip:{trigger:"item",formatter:e=>`${e.seriesName}<br/>${e.name}: ${e.data.borrowing_count?.toLocaleString()??0} 本<br/>占比: ${e.value?.toFixed(2)??0}%`},series:[{name:"借阅分类",type:"pie",radius:["40%","70%"],center:["50%","50%"],avoidLabelOverlap:!1,label:{show:!0,formatter:"{b}\n{d}%",position:"outside",fontSize:11},emphasis:{label:{show:!0,fontSize:"16",fontWeight:"bold",formatter:"{b}\n{d}%"}},labelLine:{show:!0,length:8,length2:10},data:v}]};r.setOption(y),window.addEventListener("resize",(function(){n.resize(),o.resize(),r.resize()}))}function initializeCostCharts(){document.getElementById("midSizeLibraryCostChart")}function initializeFeedbackCharts(){"undefined"==typeof Plotly?console.error("Plotly library not found. Feedback heatmaps will not be initialized."):function(){const e=document.getElementById("heatmap_container");if(!e)return void console.error("Plotly heatmap container (#heatmap_container) not found.");var t=[{z:[[138,161,66,40,52,23,18,6,15,10],[176,132,54,45,63,32,35,78,17,21]],x:["涧西区","洛龙区","瀍河区","老城区","西工区","伊滨区","孟津区","文化广电和旅游局","偃师区","伊川县"],y:["设施环境问题","运营服务问题"],type:"heatmap",colorscale:[[0,"rgb(255, 255, 220)"],[.2,"rgb(217, 240, 211)"],[.4,"rgb(173, 221, 208)"],[.6,"rgb(120, 198, 224)"],[.8,"rgb(49, 133, 189)"],[1,"rgb(8, 29, 88)"]],showscale:!0,hoverongaps:!1,hoverlabel:{bgcolor:"white",font:{size:14}},hovertemplate:"<b>%{y}</b><br>%{x}: %{z}条<extra></extra>",colorbar:{title:"反馈量（条）",titleside:"right"}}],a={title:null,margin:{l:120,r:80,b:100,t:10,pad:4},xaxis:{title:"",tickangle:-45,tickfont:{size:12}},yaxis:{title:"",tickfont:{size:12}},annotations:[]},n={responsive:!0,displayModeBar:!1};Plotly.newPlot(e,t,a,n),window.addEventListener("resize",(function(){Plotly.relayout(e,{width:e.offsetWidth})}))}(),"undefined"==typeof echarts?console.error("ECharts library not found. Feedback trend chart will not be initialized."):function(){const e=document.getElementById("feedbackMonthlyTrendChart");if(!e)return void console.error("ECharts trend chart container (#feedbackMonthlyTrendChart) not found.");const t=echarts.init(e),a={all:{years:[2017,2018,2019,2020,2021,2022,2023,2024,2025],months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],values:[[0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,1,0,2,0,0,1,0,1,21],[19,6,21,12,15,26,23,21,19,10,13,9],[13,4,7,11,18,22,28,27,5,6,12,10],[20,13,10,11,14,22,38,16,15,14,17,14],[24,23,15,29,18,49,71,27,20,6,16,22],[17,19,14,10,19,18,39,25,11,23,9,15],[22,21,18,17,18,28,36,30,17,16,11,19],[19,15,23,0,0,0,0,0,0,0,0,0]]},"咨询":{years:[2018,2019,2020,2021,2022,2023,2024,2025],months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],values:[[0,0,0,0,0,0,0,0,0,0,0,10],[6,6,9,3,5,9,4,9,4,2,2,4],[6,2,5,6,12,10,4,7,2,5,4,5],[4,3,5,5,4,4,5,13,4,4,6,4],[14,11,3,14,5,12,10,2,4,4,9,14],[8,11,0,3,5,3,11,6,6,9,3,5],[5,5,3,1,2,10,6,6,5,3,4,2],[5,3,2,0,0,0,0,0,0,0,0,0]]},"建议":{years:[2018,2019,2020,2021,2022,2023,2024,2025],months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],values:[[0,0,0,1,0,2,0,0,1,0,1,9],[7,0,5,3,7,4,12,9,8,5,7,4],[4,1,2,4,3,6,8,6,0,0,4,3],[5,4,3,1,0,9,12,1,1,3,1,5],[7,2,8,8,6,17,18,10,6,0,3,1],[1,1,5,1,2,3,11,5,0,3,1,5],[8,4,5,2,3,3,7,4,2,6,1,3],[4,0,5,0,0,0,0,0,0,0,0,0]]},"投诉":{years:[2017,2018,2019,2020,2021,2022,2023,2024,2025],months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],values:[[0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,0,2],[6,0,7,6,3,13,7,3,7,3,4,1],[3,1,0,1,3,6,16,14,3,1,4,2],[11,6,2,5,10,9,21,2,10,7,10,5],[3,10,4,7,7,20,43,15,10,2,4,7],[8,7,9,6,12,12,17,14,5,11,5,5],[9,12,10,14,13,15,23,20,10,7,6,14],[10,12,16,0,0,0,0,0,0,0,0,0]]}};let n="月度";const o=document.createElement("div");o.style.cssText="text-align: center; margin-bottom: 12px; display: flex; justify-content: center; gap: 10px;",e.parentNode.insertBefore(o,e);function r(){o.querySelectorAll("button").forEach((e=>{const t=e.dataset.scale===n;e.style.backgroundColor=t?"#1890ff":"#f0f0f0",e.style.color=t?"white":"black",e.style.borderColor=t?"#1890ff":"#ddd"}))}function i(e){const t=[],n=[],o=a.all.years,r=a.all.months;for(let a=0;a<o.length;a++){const i=o[a],l=e.years.indexOf(i);for(let a=0;a<r.length&&!(2025===i&&a>=3);a++){const o=`${i}-${(a+1).toString().padStart(2,"0")}`;n.push(o);let r=0;-1!==l&&void 0!==e.values[l]?.[a]&&(r=e.values[l][a]),t.push(r)}}return{data:t,labels:n}}function l(e){const t=[],n=[],o=a.all.years;for(let a=0;a<o.length;a++){const r=o[a],i=e.years.indexOf(r);for(let a=0;a<4;a++){const o=3*a,l=o+2;if(2025===r&&a>0)break;let s=0,c=!1;if(-1!==i)for(let t=o;t<=l&&!(2025===r&&t>=3);t++)void 0!==e.values[i]?.[t]&&(s+=e.values[i][t],c=!0);(c||r<2025||2025===r&&0===a)&&(n.push(`${r}-Q${a+1}`),t.push(s))}}return{data:t,labels:n}}function s(e){const t=[],n=[],o=a.all.years;for(let a=0;a<o.length;a++){const r=o[a],i=e.years.indexOf(r);let l=0,s=!1;if(-1!==i){const t=2025===r?3:12;for(let a=0;a<t;a++)void 0!==e.values[i]?.[a]&&(l+=e.values[i][a],s=!0)}s&&(n.push(`${r}`),t.push(l))}return{data:t,labels:n}}function c(){let e,o,r,c,d;"月度"===n?(e=i(a.all),o=i(a["咨询"]),r=i(a["建议"]),c=i(a["投诉"]),d=e=>{const t=e.split("-");return"01"===t[1]?t[0]:["04","07","10"].includes(t[1])?`Q${Math.ceil(parseInt(t[1])/3)}`:""}):"季度"===n?(e=l(a.all),o=l(a["咨询"]),r=l(a["建议"]),c=l(a["投诉"]),d=e=>e):(e=s(a.all),o=s(a["咨询"]),r=s(a["建议"]),c=s(a["投诉"]),d=e=>e);const u={tooltip:{trigger:"axis",axisPointer:{type:"cross"}},legend:{data:["咨询","建议","投诉","总量"],selected:{"咨询":!0,"建议":!0,"投诉":!0,"总量":!1},top:"bottom",inactiveColor:"#ccc"},grid:{left:"3%",right:"4%",bottom:"15%",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:e.labels,axisLabel:{rotate:"月度"===n?30:0,interval:"auto",formatter:d},axisTick:{alignWithLabel:!0}},yAxis:{type:"value",name:"反馈数量（条）",min:0,axisLabel:{formatter:"{value}"}},dataZoom:[{type:"inside",start:0,end:100},{start:0,end:100,height:25,bottom:"5%",handleIcon:"M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z",handleSize:"80%",handleStyle:{color:"#fff",shadowBlur:3,shadowColor:"rgba(0, 0, 0, 0.6)",shadowOffsetX:2,shadowOffsetY:2}}],series:[{name:"咨询",type:"line",smooth:!0,data:o.data,itemStyle:{color:"#5470C6"},lineStyle:{width:2},emphasis:{focus:"series"}},{name:"建议",type:"line",smooth:!0,data:r.data,itemStyle:{color:"#91CC75"},lineStyle:{width:2},emphasis:{focus:"series"}},{name:"投诉",type:"line",smooth:!0,data:c.data,itemStyle:{color:"#EE6666"},lineStyle:{width:2},emphasis:{focus:"series"}},{name:"总量",type:"line",smooth:!0,data:e.data,itemStyle:{color:"#fac858"},lineStyle:{width:3,type:"dashed"},emphasis:{focus:"series"}}]};t.setOption(u,!0)}["月度","季度","年度"].forEach((e=>{const t=document.createElement("button");t.textContent=e+"趋势",t.dataset.scale=e,t.style.cssText="padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; background-color: #f0f0f0; border: 1px solid #ddd;",e===n&&(t.style.backgroundColor="#1890ff",t.style.color="white",t.style.borderColor="#1890ff"),t.addEventListener("click",(()=>{e!==n&&(n=e,r(),c())})),o.appendChild(t)})),t.on("legendselectchanged",(function(e){const a=e.selected["总量"],n=e.name;let o={...e.selected};if("总量"===n)o["咨询"]=!a,o["建议"]=!a,o["投诉"]=!a;else{(o["咨询"]||o["建议"]||o["投诉"])&&(o["总量"]=!1)}t.setOption({legend:{selected:o}})})),window.addEventListener("resize",(function(){t.resize()})),c(),setTimeout((function(){t.resize()}),200)}(),"undefined"==typeof Chart?console.error("Chart.js library not found. Feedback detail charts will not be initialized."):function(){const e=document.getElementById("level1FeedbackChart")?.getContext("2d"),t=document.getElementById("level2FeedbackChart")?.getContext("2d");if(!e||!t)return void console.error("Chart.js canvas elements (#level1FeedbackChart or #level2FeedbackChart) not found.");new Chart(e,{type:"doughnut",data:{labels:["运营服务问题","设施环境问题","其他问题"],datasets:[{label:"反馈数量",data:[789,594,56],backgroundColor:["rgba(255, 159, 64, 0.7)","rgba(54, 162, 235, 0.7)","rgba(201, 203, 207, 0.7)"],borderColor:["rgba(255, 159, 64, 1)","rgba(54, 162, 235, 1)","rgba(201, 203, 207, 1)"],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{padding:15}},tooltip:{callbacks:{label:e=>{let t=e.label||"",a=e.raw||0;return`${t}: ${a}条 (${(a/(e.chart.getDatasetMeta(0).total||1)*100).toFixed(1)+"%"})`}}}},cutout:"60%"}});const a={"运营服务":"rgba(255, 159, 64, 0.7)","设施环境":"rgba(54, 162, 235, 0.7)"},n={"开放时间调整":"运营服务","人员服务问题":"运营服务","空间规划与选址":"设施环境","噪音控制问题":"设施环境","空调通风系统":"设施环境","卫生设施问题":"设施环境","物理设施损坏":"设施环境","座位资源不足":"设施环境","照明系统问题":"设施环境","饮水设施问题":"设施环境"},o=["开放时间调整","人员服务问题","空间规划与选址","噪音控制问题","空调通风系统","卫生设施问题","物理设施损坏","座位资源不足","照明系统问题","饮水设施问题"].reverse(),r=[409,304,300,86,75,67,49,47,26,18].reverse(),i=o.map((e=>n[e]?a[n[e]]:"rgba(201, 203, 207, 0.7)")),l=i.map((e=>e.replace("0.7","1")));new Chart(t,{type:"bar",data:{labels:o,datasets:[{label:"反馈数量",data:r,backgroundColor:i,borderColor:l,borderWidth:1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`${n[e.label]||"其他"}类: ${e.raw}条`}}},scales:{x:{beginAtZero:!0,title:{display:!0,text:"反馈数量（条）"}},y:{ticks:{font:{size:11}}}}}})}()}function initializeNationalDistributionChart(){const e=document.getElementById("nationalDistributionChart");if(!e||"undefined"==typeof echarts)return;const t=echarts.init(e),a=[{name:"浙江",value:531,cities:[{name:"温州",value:172},{name:"台州",value:102},{name:"绍兴",value:75},{name:"衢州",value:42},{name:"湖州",value:35},{name:"嘉兴",value:31},{name:"舟山",value:21},{name:"宁波",value:18},{name:"丽水",value:14},{name:"杭州",value:12},{name:"金华",value:9}]},{name:"河南",value:353,cities:[{name:"洛阳",value:204},{name:"郑州",value:89},{name:"驻马店",value:27},{name:"开封",value:22},{name:"南阳",value:8},{name:"焦作",value:3}]},{name:"广东",value:233,cities:[{name:"佛山",value:188},{name:"韶关",value:35},{name:"深圳",value:10}]},{name:"山东",value:232,cities:[{name:"济南",value:53},{name:"淄博",value:45},{name:"威海",value:44},{name:"济宁",value:37},{name:"日照",value:25},{name:"临沂",value:14},{name:"菏泽",value:14}]},{name:"江苏",value:170,cities:[{name:"苏州",value:64},{name:"扬州",value:51},{name:"常州",value:41},{name:"连云港",value:9},{name:"常熟",value:5}]},{name:"安徽",value:169,cities:[{name:"合肥",value:99},{name:"芜湖",value:46},{name:"铜陵",value:16},{name:"淮北",value:5},{name:"滁州",value:3}]},{name:"上海",value:120,cities:[{name:"上海",value:120}]},{name:"湖北",value:68,cities:[{name:"武汉",value:52},{name:"孝感",value:8},{name:"黄冈",value:6},{name:"宜昌",value:2}]},{name:"江西",value:59,cities:[{name:"南昌",value:37},{name:"九江",value:20},{name:"萍乡",value:2}]},{name:"内蒙古",value:58,cities:[{name:"呼和浩特",value:58}]},{name:"北京",value:57,cities:[{name:"北京",value:57}]},{name:"河北",value:38,cities:[{name:"沧州",value:19},{name:"唐山",value:13},{name:"廊坊",value:6}]},{name:"天津",value:28,cities:[{name:"天津",value:28}]},{name:"重庆",value:27,cities:[{name:"重庆",value:27}]},{name:"山西",value:26,cities:[{name:"太原",value:18},{name:"晋中",value:8}]}];a.sort(((e,t)=>t.value-e.value));const n=a.slice(0,15);function o(){return{title:{text:"全国城市书房分布 (Top 15省份)",left:"center",top:10,subtext:"点击省份条形图可查看省内城市分布",subtextStyle:{color:"#666",fontSize:12}},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:"{b}: {c} 家"},grid:{left:"3%",right:"4%",bottom:"3%",top:"80px",containLabel:!0},xAxis:{type:"value",boundaryGap:[0,.01],name:"数量 (家)",nameLocation:"middle",nameGap:25},yAxis:{type:"category",data:n.map((e=>e.name)).reverse(),axisLabel:{interval:0}},series:[{name:"城市书房数量",type:"bar",data:n.map((e=>e.value)).reverse(),itemStyle:{color:new echarts.graphic.LinearGradient(0,0,1,0,[{offset:0,color:"#83bff6"},{offset:.5,color:"#188df0"},{offset:1,color:"#188df0"}])},emphasis:{itemStyle:{color:new echarts.graphic.LinearGradient(0,0,1,0,[{offset:0,color:"#2378f7"},{offset:.7,color:"#2378f7"},{offset:1,color:"#83bff6"}])}}}]}}t.setOption(o());let r=null;function i(a=!1){r||(r=document.createElement("button"),r.textContent="返回省份分布",r.className="back-to-province",r.style.cssText="position: absolute; left: 20px; top: 15px; z-index: 100; padding: 8px 15px; background-color: #188df0; color: white; border: none; border-radius: 4px; cursor: pointer;",r.addEventListener("click",(function(){t.setOption(o(),!0),i(!1)})),e.parentNode.style.position="relative",e.parentNode.appendChild(r)),r.style.display=a?"block":"none"}t.on("click",(function(e){if("series"===e.componentType&&"bar"===e.seriesType){const n=e.name,o=a.find((e=>e.name===n));o?.cities?.length>0&&(t.setOption(function(e){const t=(a.find((t=>t.name===e))?.cities?.sort(((e,t)=>t.value-e.value))||[]).map((e=>({name:e.name,value:e.value})));return{title:{text:`${e}省城市书房分布`,left:"center",top:10},tooltip:{trigger:"item",formatter:"{b}: {c} 家 ({d}%)"},legend:{orient:"vertical",right:10,top:"center",type:"scroll",data:t.map((e=>e.name))},series:[{name:"城市分布",type:"pie",radius:["40%","70%"],center:["50%","55%"],avoidLabelOverlap:!0,itemStyle:{borderRadius:10,borderColor:"#fff",borderWidth:2},label:{show:!0,formatter:"{b}\n{c}家 ({d}%)"},emphasis:{label:{show:!0,fontSize:"16",fontWeight:"bold"}},data:t}]}}(n),!0),i(!0))}})),window.addEventListener("resize",(function(){t.resize()})),setTimeout((function(){t.resize()}),200)}function initializeLibraryModal(){const e=document.getElementById("libraryModal"),t=e?.querySelector(".close-button"),a=document.querySelectorAll(".showcase-item.library-card");if(!e||!t||0===a.length)return void console.warn("Modal elements (#libraryModal, .close-button) not found or no library cards (.showcase-item.library-card) present. Modal functionality disabled.");const n={shangyang:{name:"上阳宫城市书房",image:"static/picture/shangyang-library.webp",features:"坐落于上阳宫文化园内，建筑风格与园区唐风遗韵巧妙融合，提供沉浸式历史文化阅读体验。（注：该书房目前正在进行搬迁升级，具体开放信息请关注官方公告）",stats:{"类型":"历史文脉型 / 景区融合","原面积":"约 200 ㎡","原座席":"约 60 个","原藏书量":"约 7,000 册","特色":"唐风古韵，环境典雅，文旅结合","当前状态":"<strong style='color:orange;'>搬迁升级中</strong>"},description:"作为历史文脉型书房的代表，原上阳宫城市书房不仅是一个阅读空间，更是体验唐代宫廷文化、感受古都魅力的窗口。它将阅读服务与历史文化景区有机结合，吸引了大量市民和游客。目前，该书房正在进行搬迁升级，期待未来以崭新的面貌重新服务读者，具体信息请以官方发布为准。"},yirenfang:{name:"宜人坊城市书房 (洛龙区最大)",image:"static/picture/yiren-library.webp",features:"由4S店改造升级，保留现代工业风设计，通过绿植与落地窗营造开放而静谧的阅读氛围。荣获河南省新型公共文化空间典型案例。",stats:{"类型":"空间改造共建型","面积":"超 1000 ㎡","座席":"150 余个","藏书量":"配备 2 万余册","开放时间":"自2019年开放 8:30-21:30"},description:"宜人坊城市书房是洛阳探索“空间改造+社会参与”模式的杰出范例。它将闲置的大型商业空间巧妙转型为公共文化地标，不仅极大地拓展了阅读服务覆盖面，更以其独特的设计感、丰富的藏书和完善的便民设施（如水吧、儿童区），成为备受市民喜爱的“文化客厅”和社交空间。其成功经验为盘活城市存量资产、实现文化功能植入提供了宝贵借鉴。"},community_park:{name:"伊川县西山植物园城市书房",image:"static/picture/yichuan-library.webp",features:"嵌入风景优美的西山植物园中，环境宜人，将阅读与自然休闲完美结合，服务周边社区居民及公园游客。",stats:{"类型":"社区嵌入型 / 公园型","面积":"105 ㎡","座席":"42","藏书量":"约 5,000-6,000 册 (标准配置)","特色":"环境优美，亲近自然，服务社区及游客"},description:"此类“小而美”的书房是“河洛书苑”网络的重要组成部分，它们如同散落在社区公园里的“文化珍珠”，将阅读的便利送到了市民的日常生活中。西山植物园书房充分利用了公园的优美环境，为市民和游客提供了一个可以在鸟语花香中休憩、阅读的宁静角落，体现了公共文化服务的人性化关怀和与城市绿色空间的融合。"}},o=document.getElementById("modal-library-name"),r=document.getElementById("modal-library-image"),i=document.getElementById("modal-library-features"),l=document.getElementById("modal-library-description"),s=document.getElementById("modal-library-stats");function c(){e.classList.remove("show"),setTimeout((()=>{e.style.display="none"}),300)}a.forEach((t=>{t.addEventListener("click",(function(){const t=this.getAttribute("data-library-id"),a=n[t];if(a&&o&&r&&i&&l&&s){if(o.textContent=a.name,r.src=a.image,r.alt=a.name+" 图片",i.textContent=a.features,l.textContent=a.description,s.innerHTML="",a.stats)for(const e in a.stats){const t=document.createElement("li");t.innerHTML=`<i class="fas fa-check-circle" style="color:#28a745; margin-right: 8px; font-size: 0.9em;"></i><strong>${e}:</strong> ${a.stats[e]}`,s.appendChild(t)}e.style.display="flex",e.offsetWidth,e.classList.add("show")}else console.error("Details not found for library ID:",t," or essential modal elements (#modal-library-name, #modal-library-image, etc.) are missing.")}))})),t.addEventListener("click",c),e.addEventListener("click",(function(t){t.target===e&&c()})),document.addEventListener("keydown",(function(t){"Escape"===t.key&&e.classList.contains("show")&&c()}))}document.addEventListener("DOMContentLoaded",(function(){initializeLanguageSwitch(),initializeMapFullscreenLogic(),initializeBookstoreTreemap(),initializeDistrictDistributionChart(),initializePopulationCharts(),initializeVisitorBorrowingCharts(),initializeCostCharts(),initializeFeedbackCharts(),initializeNationalDistributionChart(),initializeLibraryModal()}));