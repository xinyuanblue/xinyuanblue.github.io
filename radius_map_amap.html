<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>十五分钟阅读圈分布</title>
    <link rel="stylesheet" href="./static/css/isochrone-map.css">
    
    <!-- 预连接CDN服务器，提前建立连接 -->
    <link rel="preconnect" href="https://webapi.amap.com">
    <link rel="dns-prefetch" href="https://webapi.amap.com">
    <link rel="preconnect" href="https://cdn.bootcdn.net">
    <link rel="dns-prefetch" href="https://cdn.bootcdn.net">
    
    <!-- 预览模式样式 -->
    <style>
        body { margin: 0; padding: 0; }
        .mobile-note { display: none; } 
        .map-container { width: 100vw; height: 100vh; position: relative; }
        .amap-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .panel-container { position: absolute; z-index: 100; bottom: 20px; left: 50%; transform: translateX(-50%); }
        .legend { font-size: 12px; }
        /* 预览模式顶部覆盖 */
        .preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* 隐藏部分不相关控件 */
        .back-to-list, .map-type-switch { display: none !important; }
    </style>

    <!-- 地图控件样式 -->
    <style>
        /* 地图容器 */
        #amap-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* 主控制按钮组 */
        .map-controls {
            position: absolute;
            right: 10px;
            top: 50px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .map-controls button {
            width: 140px;
            padding: 6px 12px;
            background: #fff;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 14px;
            margin: 2px 0;
            white-space: nowrap;
        }

        .map-controls button:hover {
            background: #f5f5f5;
            transform: scale(1.02);
        }

        .map-controls button.active {
            background: #2ecc71;
            color: white;
            border-color: #2ecc71;
        }
        
        /* 提示框样式 */
        .tooltip {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px 20px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 2000;
            text-align: center;
            pointer-events: none;
            max-width: 500px;
            width: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: opacity 0.3s ease;
            line-height: 1.6;
        }

        .tooltip small {
            display: block;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 13px;
            opacity: 0.9;
            line-height: 1.8;
        }

        /* 全屏相关样式 */
        .fullscreen-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            transition: all 0.3s ease;
        }
        
        .fullscreen-btn svg {
            width: 20px;
            height: 20px;
            transition: all 0.3s ease;
        }
        
        .fullscreen-btn:hover {
            background: #f5f5f5;
            transform: scale(1.05);
        }
        
        .map-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
        }

        /* 右侧控件统一样式 */
        .map-container.fullscreen .map-controls {
            right: 10px;
            background: white;
            padding: 12px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .map-container.fullscreen .map-controls {
            top: 60px;
        }

        /* 统一按钮样式 */
        .map-container.fullscreen .map-controls button {
            width: 140px;
            padding: 8px 12px;
            background: #fff;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 14px;
            margin: 2px 0;
        }

        .map-container.fullscreen .map-controls button:hover {
            background: #f5f5f5;
            transform: scale(1.02);
        }

        .map-container.fullscreen .map-controls button.active {
            background: #2ecc71;
            color: white;
            border-color: #2ecc71;
        }
        
        /* 左侧图例样式 */
        .fullscreen-legend {
            display: none;
            position: absolute;
            right: 10px;
            bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 180px;
            z-index: 1000;
        }

        .map-container.fullscreen .fullscreen-legend {
            display: block;
        }

        .fullscreen-legend h4 {
            margin: 0 0 4px 0;
            font-size: 12px;
            color: #333;
            font-weight: bold;
        }

        .fullscreen-legend .legend-section {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .fullscreen-legend .legend-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .fullscreen-legend .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
            font-size: 11px;
            white-space: nowrap;
        }

        .fullscreen-legend .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 4px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        /* 顶部信息栏样式 */
        .fullscreen-info {
            display: none;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            text-align: center;
            max-width: 600px;
        }

        .map-container.fullscreen .fullscreen-info {
            display: block;
        }

        .fullscreen-info h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #333;
        }

        .fullscreen-info p {
            margin: 0;
            font-size: 13px;
            color: #666;
        }

        /* 底部按钮组样式 */
        .bottom-controls {
            position: absolute;
            right: 10px;
            top: 380px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        /* 全屏状态下的按钮组位置调整 */
        .map-container.fullscreen .bottom-controls {
            top: 420px;
        }

        .bottom-controls button {
            width: 140px;
            padding: 6px 12px;
            background: #fff;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 14px;
            white-space: nowrap;
        }

        .bottom-controls button:hover {
            background: #f5f5f5;
            transform: scale(1.02);
        }
    </style>
</head>
<body>
    <div class="container">
 
        
        <div id="map-container" class="map-container">
            <div id="amap-container"></div>
            
            <div class="map-controls">
                <button id="show-all">显示所有阅读圈</button>
                <button id="toggle-view-range">切换全市视角</button>
                <button id="reset-view">重置视图</button>
            </div>
            
            <div class="fullscreen-legend">
                <div class="legend-section">
                    <h4>步行范围</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(46, 204, 113, 0.7);"></div>
                        <span>5分钟 (约400m)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(52, 152, 219, 0.7);"></div>
                        <span>10分钟 (约800m)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: rgba(155, 89, 182, 0.7);"></div>
                        <span>15分钟 (约1.2km)</span>
                    </div>
                </div>
                
                <div class="legend-section">
                    <h4>区域分布</h4>
                    <div id="fullscreen-district-legend"></div>
                </div>
            </div>
            
            <button class="fullscreen-btn" id="fullscreen-toggle" title="切换全屏">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                </svg>
            </button>
            
            <div id="tooltip" class="tooltip">
                点击彩色圆点查看书房详情，使用右侧控件切换显示模式和视角
            </div>
        </div>
        
        <div class="count">
            <div class="num">0</div>
            <div class="txt">城市书房</div>
        </div>
        
        <div class="map-legend">
            <h3 class="legend-title">图例说明</h3>
            
            <div id="radius-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(46, 204, 113, 0.7);"></div>
                    <span>5分钟步行圈 (约400m)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(52, 152, 219, 0.7);"></div>
                    <span>10分钟步行圈 (约800m)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(155, 89, 182, 0.7);"></div>
                    <span>15分钟步行圈 (约1.2km)</span>
                </div>
            </div>
            
            <h4 class="legend-title" style="margin-top: 20px;">区域分布</h4>
            <div id="district-legend" class="district-legend"></div>
        </div>
    </div>

    <!-- 地图相关脚本 -->
    <script src="./static/js/index.min.js"></script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=8c0f2606de763666d42b04bb5ec5b0e3"></script>
    <script src="https://webapi.amap.com/loca?v=2.0.0&key=8c0f2606de763666d42b04bb5ec5b0e3"></script>
    
    <!-- 主要应用脚本 -->
    <script src="./static/js/utils.js"></script>
    <script src="./static/js/isochrone-map/isochroneMap.js"></script>
    <script src="./static/js/isochrone-map/amapManager.js"></script>
    <script src="./static/js/isochrone-map/dataLoader.js"></script>
    <script src="./static/js/isochrone-map/controls.js"></script>

    <script>
        // 配置常量
        const CONFIG = {
            MAP_CENTER: [112.434468, 34.663041],
            MAP_ZOOM: 12,
            MAP_PITCH: 0,
            CITY_VIEW: {
                center: [112.434468, 34.663041],
                zoom: 10
            },
            DOWNTOWN_VIEW: {
                center: [112.434468, 34.663041],
                zoom: 12.5
            },
            WALKING_SPEED: 5,
            WALKING_DISTANCES: {
                FIVE_MINUTES: 400,
                TEN_MINUTES: 800,
                FIFTEEN_MINUTES: 1200
            },
            DISTRICT_COLORS: {
                '西工区': '#FF5252',
                '涧西区': '#FFAB40',
                '老城区': '#4CAF50',
                '瀍河区': '#42A5F5',
                '洛龙区': '#AB47BC',
                '伊滨区': '#FF7043',
                '孟津区': '#D32F2F',
                '偃师区': '#26C6DA',
                '新安县': '#EC407A',
                '伊川县': '#FF6F61',
                '栾川县': '#6A1B9A',
                '嵩县': '#5C6BC0',
                '汝阳县': '#26A69A',
                '宜阳县': '#9CCC65',
                '洛宁县': '#FFEE58'
            }
        };

        // 地图管理器
        class MapManager {
            constructor() {
                this.amap = null;
                this.loca = null;
                this.currentInfoWindow = null;
                this.allCircles = [];
                this.isShowingAll = false;
                this.districtCount = {};
                this.isFullscreen = false;
                this.showing3D = false;
                this.allBookstores = [];
                this.isDowntownView = true; // 默认显示主城区视角
                this.tooltipShown = false;
            }

            init() {
                this.setupCanvas();
                this.initAMap();
                this.setupEventListeners();
                
                // 初始化显示AMap
                document.getElementById('amap-container').style.display = 'block';
                document.getElementById('radius-legend').style.display = 'block';
                
                // 初始化为主城区视角
                this.setDowntownView();

                // 显示初始提示
                const tooltip = document.getElementById('tooltip');
                tooltip.innerHTML = `点击彩色圆点查看书房详情，使用右侧控件切换显示模式和视角<br>点击右上角全屏展示效果更佳<br><small style="display: block; margin-top: 8px; opacity: 0.8;">• 点击任意彩色圆点即可关闭该提示框<br>• 按ESC键可退出全屏</small>`;
                tooltip.style.display = 'block';
                this.tooltipShown = true;
            }

            setupCanvas() {
                const originalGetContext = HTMLCanvasElement.prototype.getContext;
                HTMLCanvasElement.prototype.getContext = function(type, attributes = {}) {
                    if (type === '2d') {
                        attributes.willReadFrequently = true;
                    }
                    return originalGetContext.call(this, type, attributes);
                };
            }

            initAMap() {
                this.amap = new AMap.Map('amap-container', {
                    zoom: CONFIG.MAP_ZOOM,
                    center: CONFIG.MAP_CENTER,
                    viewMode: '3D',
                    mapStyle: 'amap://styles/dark',
                    pitch: CONFIG.MAP_PITCH
                });

                this.loca = new Loca.Container({
                    map: this.amap
                });
            }

            setupEventListeners() {
                // 视图控制事件
                document.getElementById('reset-view').addEventListener('click', () => this.resetView());
                document.getElementById('show-all').addEventListener('click', () => this.toggleShowAll());

                // 全屏控制事件
                document.getElementById('fullscreen-toggle').addEventListener('click', () => {
                    this.toggleFullscreen();
                });

                document.addEventListener('fullscreenchange', () => {
                    const container = document.getElementById('map-container');
                    if (document.fullscreenElement === container) {
                        container.classList.add('fullscreen');
                    } else {
                        container.classList.remove('fullscreen');
                    }
                    
                    // 更新地图大小
                    if (this.amap) {
                        this.amap.resize();
                    }
                });

                // 添加视角切换事件监听
                document.getElementById('toggle-view-range').addEventListener('click', () => this.toggleViewRange());

                // 为所有控件添加点击事件，点击后隐藏提示
                document.querySelectorAll('.map-controls button')
                    .forEach(button => {
                        button.addEventListener('click', () => this.hideTooltip());
                    });
            }

            toggleShowAll() {
                this.isShowingAll = !this.isShowingAll;
                const button = document.getElementById('show-all');
                
                if (this.isShowingAll) {
                    button.textContent = '隐藏阅读圈';
                    button.classList.add('active');
                    this.allCircles.forEach(circles => {
                        circles.five.show();
                        circles.ten.show();
                        circles.fifteen.show();
                    });
                } else {
                    button.textContent = '显示所有阅读圈';
                    button.classList.remove('active');
                    this.allCircles.forEach(circles => {
                        circles.five.hide();
                        circles.ten.hide();
                        circles.fifteen.hide();
                    });
                }
            }

            toggle3DView() {
                this.showing3D = !this.showing3D;
                const button = document.getElementById('toggle-view');
                
                if (this.showing3D) {
                    button.textContent = '切换平面视图';
                    this.amap.setPitch(45);
                } else {
                    button.textContent = '切换3D视图';
                    this.amap.setPitch(0);
                }
            }

            resetView() {
                this.amap.setCenter(CONFIG.MAP_CENTER);
                this.amap.setZoom(CONFIG.MAP_ZOOM);
                this.amap.setPitch(CONFIG.MAP_PITCH);
            }

            toggleFullscreen() {
                const container = document.getElementById('map-container');
                
                if (!document.fullscreenElement) {
                    container.requestFullscreen().catch(err => {
                        console.error(`全屏请求失败: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
                
                // 更新地图大小
                setTimeout(() => {
                    if (this.amap) {
                        this.amap.resize();
                    }
                }, 100);
            }

            setDowntownView() {
                this.isDowntownView = true;
                this.amap.setZoomAndCenter(CONFIG.DOWNTOWN_VIEW.zoom, CONFIG.DOWNTOWN_VIEW.center);
                document.getElementById('toggle-view-range').textContent = '切换全市视角';
                document.getElementById('toggle-view-range').classList.add('active');
            }

            setCityView() {
                this.isDowntownView = false;
                this.amap.setZoomAndCenter(CONFIG.CITY_VIEW.zoom, CONFIG.CITY_VIEW.center);
                document.getElementById('toggle-view-range').textContent = '切换主城区视角';
                document.getElementById('toggle-view-range').classList.remove('active');
            }

            toggleViewRange() {
                if (this.isDowntownView) {
                    this.setCityView();
                } else {
                    this.setDowntownView();
                }
            }

            showTooltip(text) {
                const tooltip = document.getElementById('tooltip');
                tooltip.innerHTML = `${text}<br>点击右上角全屏展示效果更佳<br><small style="display: block; margin-top: 8px; opacity: 0.8;">• 点击任意彩色圆点即可关闭该提示框<br>• 按ESC键可退出全屏</small>`;
                tooltip.style.display = 'block';
                this.tooltipShown = true;
            }

            hideTooltip() {
                if (this.tooltipShown) {
                    document.getElementById('tooltip').style.display = 'none';
                    this.tooltipShown = false;
                }
            }

            setupMarkerClickEvent(marker, circles) {
                try {
                    marker.on('click', () => {
                        // 隐藏提示
                        this.hideTooltip();

                        if (this.currentInfoWindow) {
                            this.currentInfoWindow.close();
                        }

                        if (!this.isShowingAll) {
                            this.allCircles.forEach(c => {
                                c.five.hide();
                                c.ten.hide();
                                c.fifteen.hide();
                            });
                        }

                        circles.five.show();
                        circles.ten.show();
                        circles.fifteen.show();

                        // 从marker的extData中获取数据
                        const markerData = marker.getExtData();
                        
                        const infoWindow = new AMap.InfoWindow({
                            content: this.createInfoWindowContent(markerData),
                            offset: new AMap.Pixel(0, -10),
                            closeWhenClickMap: true
                        });

                        this.currentInfoWindow = infoWindow;
                        infoWindow.open(this.amap, marker.getPosition());

                        // 修复事件监听器
                        if (infoWindow && typeof infoWindow.on === 'function') {
                            infoWindow.on('close', () => {
                                if (!this.isShowingAll) {
                                    circles.five.hide();
                                    circles.ten.hide();
                                    circles.fifteen.hide();
                                }
                            });
                        }
                    });

                    marker.on('mouseover', () => this.amap.setDefaultCursor('pointer'));
                    marker.on('mouseout', () => this.amap.setDefaultCursor('default'));
                } catch (error) {
                    console.error('设置标记点击事件时出错:', error);
                }
            }
            
            createInfoWindowContent(lib) {
                // 使用更安全的方式处理开放时间
                let opening_hours = '9:00-17:00';  // 默认值
                if (typeof lib.opening_hours === 'string' && lib.opening_hours.trim()) {
                    opening_hours = lib.opening_hours;
                } else if (lib.name === '朱樱塔城市书房') {
                    opening_hours = '9:00-21:00';  // 特定值
                }
                
                return `
                    <div style="padding: 15px; background-color: rgba(0,0,0,0.8); color: #fff; border-radius: 5px;">
                        <h4 style="margin: 0 0 5px 0; color: #fff;">${lib.name}</h4>
                        <p style="margin: 0; font-size: 12px; line-height: 1.8;">
                            所属区域：${lib.district}<br>
                            地址：${lib.address}<br>
                            面积：${lib.area}㎡<br>
                            座位数：${lib.seats}个<br>
                            藏书量：${lib.books}册<br>
                            期刊种类：${lib.magazine_types}种<br>
                            开放时间：${opening_hours}
                        </p>
                    </div>
                `;
            }
            
            createWalkingCircles(lng, lat) {
                const circle5min = new AMap.Circle({
                    center: new AMap.LngLat(lng, lat),
                    radius: CONFIG.WALKING_DISTANCES.FIVE_MINUTES,
                    strokeColor: "#2ecc71",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#2ecc71",
                    fillOpacity: 0.2,
                    visible: false
                });
                
                const circle10min = new AMap.Circle({
                    center: new AMap.LngLat(lng, lat),
                    radius: CONFIG.WALKING_DISTANCES.TEN_MINUTES,
                    strokeColor: "#3498db",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#3498db",
                    fillOpacity: 0.15,
                    visible: false
                });
                
                const circle15min = new AMap.Circle({
                    center: new AMap.LngLat(lng, lat),
                    radius: CONFIG.WALKING_DISTANCES.FIFTEEN_MINUTES,
                    strokeColor: "#9b59b6",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#9b59b6",
                    fillOpacity: 0.1,
                    visible: false
                });
                
                circle5min.setMap(this.amap);
                circle10min.setMap(this.amap);
                circle15min.setMap(this.amap);

                return { five: circle5min, ten: circle10min, fifteen: circle15min };
            }
        }


               // 数据加载器
               class DataLoader {
            constructor(mapManager) {
                this.mapManager = mapManager;
            }

            async loadData() {
                try {
                    console.log('开始加载数据...');
                    const response = await fetch('/static/data/城市书房数据.json');
                    console.log('数据请求响应状态:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    
                    const rawData = await response.text();
                    const data = JSON.parse(rawData);
                    
                    // 检查数据完整性
                    if (!data || !data.districts) {
                        throw new Error('无效的数据格式');
                    }

                    // 检查是否有实际的书房数据
                    let hasLibraries = false;
                    Object.values(data.districts).forEach(district => {
                        if (district.libraries && district.libraries.length > 0) {
                            hasLibraries = true;
                        }
                    });

                    if (!hasLibraries) {
                        throw new Error('没有找到书房数据');
                    }

                    const ranges = this.calculateDataRanges(data);
                    this.initializeDistrictCounts();
                    await this.createBookstoreMarkers(data, ranges);
                    this.updateCounters();
                    this.createDistrictLegends();
                    
                    return true;
                } catch (error) {
                    console.error('数据加载详细错误:', error);
                    // 只有在确实没有加载到数据时才抛出错误
                    if (!this.mapManager.allBookstores || this.mapManager.allBookstores.length === 0) {
                        throw error;
                    }
                    return false;
                }
            }

            calculateDataRanges(data) {
                let minArea = Infinity, maxArea = -Infinity;
                let minSeats = Infinity, maxSeats = -Infinity;
                let minBooks = Infinity, maxBooks = -Infinity;

                Object.values(data.districts).forEach(district => {
                    district.libraries.forEach(lib => {
                        const area = parseFloat(lib.area) || 0;
                        const seats = parseInt(lib.seats) || 0;
                        const books = parseInt(lib.books.replace(/,/g, '')) || 0;

                        minArea = Math.min(minArea, area);
                        maxArea = Math.max(maxArea, area);
                        minSeats = Math.min(minSeats, seats);
                        maxSeats = Math.max(maxSeats, seats);
                        minBooks = Math.min(minBooks, books);
                        maxBooks = Math.max(maxBooks, books);
                    });
                });

                return { minArea, maxArea, minSeats, maxSeats, minBooks, maxBooks };
            }

            initializeDistrictCounts() {
                Object.keys(CONFIG.DISTRICT_COLORS).forEach(district => {
                    this.mapManager.districtCount[district] = 0;
                });
            }

            createBookstoreMarkers(data, ranges) {
                const allBookstores = [];
                let count = 0;

                try {
                    Object.values(data.districts).forEach(district => {
                        if (!district.libraries) return;
                        district.libraries.forEach(lib => {
                            try {
                                count++;
                                
                                // 直接从原始数据中获取opening_hours
                                const opening_hours = lib.opening_hours;
                                
                                // 创建一个新的对象来存储书房数据
                                const processedLib = {
                                    id: lib.id,
                                    name: lib.name,
                                    district: lib.district,
                                    address: lib.address,
                                    area: parseFloat(lib.area) || 0,
                                    seats: parseInt(lib.seats) || 0,
                                    books: lib.books,
                                    magazine_types: lib.magazine_types,
                                    opening_hours: opening_hours,  // 直接赋值
                                    coordinates: lib.coordinates
                                };

                                const [lng, lat] = processedLib.coordinates.split(',').map(Number);
                                
                                if (isNaN(lng) || isNaN(lat)) {
                                    console.error('无效的坐标:', processedLib.coordinates);
                                    return;
                                }

                                const bookstore = {
                                    name: processedLib.name,
                                    district: processedLib.district,
                                    coordinates: [lng, lat],
                                    details: {...processedLib}
                                };

                                allBookstores.push(bookstore);
                                this.createAMapMarker({...processedLib}, lng, lat, ranges);
                                
                                // 更新区域计数
                                if (processedLib.district && this.mapManager.districtCount[processedLib.district] !== undefined) {
                                    this.mapManager.districtCount[processedLib.district]++;
                                }
                            } catch (error) {
                                console.error('处理单个书房数据时出错:', error, lib);
                            }
                        });
                    });

                    this.mapManager.allBookstores = allBookstores;
                    document.querySelector('.num').innerText = count;
                } catch (error) {
                    console.error('处理书房数据时出错:', error);
                }
            }

            createAMapMarker(lib, lng, lat, ranges) {
                const areaRatio = (lib.area - ranges.minArea) / (ranges.maxArea - ranges.minArea);
                const booksIntensity = this.getColorIntensity(parseInt(lib.books.replace(/,/g, '')), ranges.minBooks, ranges.maxBooks);
                const baseSize = 15 + areaRatio * 25;
                const seatScale = 1 + (lib.seats / ranges.maxSeats) * 0.5;
                const finalSize = baseSize * seatScale;
                const baseColor = CONFIG.DISTRICT_COLORS[lib.district];
                const opacity = 0.6 + booksIntensity * 0.4;
                const hexOpacity = Math.round(opacity * 255).toString(16).padStart(2, '0');

                // 创建书房标记
                const marker = new AMap.Marker({
                    position: new AMap.LngLat(lng, lat),
                    content: `
                        <div style="
                            width: ${finalSize}px;
                            height: ${finalSize}px;
                            background: ${baseColor}${hexOpacity};
                            border-radius: 50%;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                            border: 2px solid ${baseColor};
                        "></div>
                    `,
                    offset: new AMap.Pixel(-finalSize/2, -finalSize/2),
                    extData: {...lib}  // 存储完整的书房数据
                });

                // 创建步行圈
                const circles = this.mapManager.createWalkingCircles(lng, lat);
                this.mapManager.allCircles.push(circles);

                // 设置点击事件
                this.mapManager.setupMarkerClickEvent(marker, circles);

                marker.setMap(this.mapManager.amap);
            }

            getColorIntensity(value, min, max) {
                return (value - min) / (max - min);
            }

            updateCounters() {
                // 更新计数器
                let totalCount = this.mapManager.allBookstores.length;
                document.querySelector('.num').innerText = totalCount;
            }

            createDistrictLegends() {
                // 创建区域图例
                const districtLegend = document.getElementById('district-legend');
                const fullscreenDistrictLegend = document.getElementById('fullscreen-district-legend');
                
                if (!districtLegend || !fullscreenDistrictLegend) return;
                
                districtLegend.innerHTML = '';
                fullscreenDistrictLegend.innerHTML = '';
                
                Object.entries(this.mapManager.districtCount)
                    .filter(([district, count]) => count > 0)
                    .sort((a, b) => b[1] - a[1])  // 按数量降序排序
                    .forEach(([district, count]) => {
                        const color = CONFIG.DISTRICT_COLORS[district];
                        
                        // 普通图例
                        districtLegend.innerHTML += `
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: ${color};"></div>
                                <span>${district} (${count})</span>
                            </div>
                        `;
                        
                        // 全屏图例
                        fullscreenDistrictLegend.innerHTML += `
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: ${color};"></div>
                                <span>${district} (${count})</span>
                            </div>
                        `;
                    });
            }
            
            createInfoWindowContent(lib) {
                // 使用更安全的方式处理开放时间
                let opening_hours = '9:00-17:00';  // 默认值
                if (typeof lib.opening_hours === 'string' && lib.opening_hours.trim()) {
                    opening_hours = lib.opening_hours;
                } else if (lib.name === '朱樱塔城市书房') {
                    opening_hours = '9:00-21:00';  // 特定值
                }
                
                return `
                    <div style="padding: 15px; background-color: rgba(0,0,0,0.8); color: #fff; border-radius: 5px;">
                        <h4 style="margin: 0 0 5px 0; color: #fff;">${lib.name}</h4>
                        <p style="margin: 0; font-size: 12px; line-height: 1.8;">
                            所属区域：${lib.district}<br>
                            地址：${lib.address}<br>
                            面积：${lib.area}㎡<br>
                            座位数：${lib.seats}个<br>
                            藏书量：${lib.books}册<br>
                            期刊种类：${lib.magazine_types}种<br>
                            开放时间：${opening_hours}
                        </p>
                    </div>
                `;
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成，开始初始化...');
            window.mapManager = new MapManager();
            const dataLoader = new DataLoader(window.mapManager);
            
            window.mapManager.init();
            console.log('地图管理器初始化完成');
            
            let dataLoadAttempted = false;
            
            const loadData = async () => {
                if (dataLoadAttempted) return;
                dataLoadAttempted = true;
                
                try {
                    await dataLoader.loadData();
                    console.log('数据加载和处理完成');
                    
                    // 数据加载完成后自动显示所有阅读圈
                    if (window.mapManager && !window.mapManager.isShowingAll) {
                        window.mapManager.isShowingAll = true;
                        const showAllButton = document.getElementById('show-all');
                        if (showAllButton) {
                            showAllButton.textContent = '隐藏阅读圈';
                            showAllButton.classList.add('active');
                        }
                        
                        if (window.mapManager.allCircles && window.mapManager.allCircles.length > 0) {
                            window.mapManager.allCircles.forEach(circles => {
                                if (circles && circles.five && circles.ten && circles.fifteen) {
                                    circles.five.show();
                                    circles.ten.show();
                                    circles.fifteen.show();
                                }
                            });
                            console.log("已显示所有阅读圈");
                        }
                    }
                } catch (error) {
                    console.error('数据加载错误:', error);
                    if (!window.mapManager.allBookstores || window.mapManager.allBookstores.length === 0) {
                        alert('加载城市书房数据失败，请检查数据文件是否存在。');
                    }
                }
            };

            // 在地图加载完成后加载数据
            window.mapManager.amap.on('complete', loadData);
        });
    </script>
</body>
</html>