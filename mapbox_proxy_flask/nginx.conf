server {
    listen 80;
    # 使用本地IP地址
    server_name 192.168.31.47;

    # Windows环境下的日志路径
    access_log logs/mapbox_access.log;
    error_log logs/mapbox_error.log;

    # 代理到api.mapbox.com的请求
    location /api/mapbox/ {
        # 去掉前缀
        rewrite ^/api/mapbox/(.*) /$1 break;
        
        # 代理到真实的Mapbox API
        proxy_pass https://api.mapbox.com/;
        proxy_ssl_server_name on;
        proxy_set_header Host api.mapbox.com;
        
        # 添加Mapbox访问令牌
        proxy_set_header Authorization "mapbox.accessToken=pk.eyJ1IjoieGlueXVhbmJsdWUiLCJhIjoiY203cHhybnp3MHYxZzJscHJyYnYwMHMzZyJ9.9Be1af0pb9DVIlt5PJ8COQ";
        
        # 设置代理头
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;
        proxy_send_timeout 30s;
        
        # 缓存设置
        proxy_cache mapbox_cache;
        proxy_cache_valid 200 302 1h;
        proxy_cache_valid 404 1m;
    }

    # 代理到瓦片服务器的请求
    location ~ ^/api/mapbox/tiles/(.*)$ {
        # 提取瓦片服务器域名和路径
        set $tile_path $1;
        
        # 代理到真实的Mapbox瓦片服务器
        proxy_pass https://a.tiles.mapbox.com/$tile_path$is_args$args;
        proxy_ssl_server_name on;
        proxy_set_header Host a.tiles.mapbox.com;
        
        # 如果第一个服务器返回错误，尝试其他服务器
        proxy_next_upstream error timeout http_404;
        
        # 添加Mapbox访问令牌
        proxy_set_header Authorization "mapbox.accessToken=pk.eyJ1IjoieGlueXVhbmJsdWUiLCJhIjoiY203cHhybnp3MHYxZzJscHJyYnYwMHMzZyJ9.9Be1af0pb9DVIlt5PJ8COQ";
        
        # 设置缓存
        proxy_cache mapbox_cache;
        proxy_cache_valid 200 302 7d;  # 瓦片缓存7天
        proxy_cache_key "$host$request_uri$is_args$args";
        
        # 设置代理头
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 增加瓦片相关的响应头
        add_header Cache-Control "public, max-age=604800";  # 7天缓存
        add_header Access-Control-Allow-Origin "*";
    }

    # 特殊处理isochrone API
    location /api/isochrone {
        # 代理到你的Flask服务器
        proxy_pass http://localhost:5001/api/isochrone;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 处理到 / 的请求，允许访问静态页面
    location / {
        root html;
        index index.html index.htm;
        try_files $uri $uri/ =404;
    }
}

# Windows环境下的缓存设置 - 注意：这部分需要放在http块内，非server块内
# 在http块中添加以下内容：
# 
# http {
#    ... 其他配置 ...
#    
#    proxy_cache_path temp/cache/nginx/mapbox levels=1:2 keys_zone=mapbox_cache:10m max_size=1g inactive=7d;
#    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
#    proxy_cache_lock on;
#    proxy_cache_background_update on;
# }